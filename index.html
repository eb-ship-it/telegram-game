<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–µ–¥–∏—Ç–∞—Ü–∏—è –¥—ã—Ö–∞–Ω–∏–µ–º –æ—Ç AnyClass</title>
  <style>
    :root{
      --bg:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#38bdf8; --accent2:#34d399; --brd:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1000px at 50% -20%, #1e293b 0%, var(--bg) 55%);
      color:var(--text); display:grid; place-items:center; min-height:100vh; padding:16px;
    }
    .app{
      width:100%; max-width:820px; background:rgba(255,255,255,.05); border:1px solid var(--brd);
      border-radius:16px; padding:18px; box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{margin:0; font-size:clamp(18px,3.2vw,28px)}
    .sub{color:var(--muted); font-size:14px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .card{background:rgba(255,255,255,.04); border:1px solid var(--brd); border-radius:14px; padding:14px}

    /* Controls */
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row label{display:flex; gap:6px; align-items:center}
    select,button{border-radius:12px; border:1px solid var(--brd); background:#0a1426; color:var(--text);
      padding:10px 12px; font-weight:600; font-size:14px}
    button{cursor:pointer; background:linear-gradient(180deg,var(--accent),#0ea5e9); color:#07121f;
      box-shadow:0 8px 20px rgba(56,189,248,.25)}
    button.ghost{background:transparent; color:var(--text)}
    button.alt{background:linear-gradient(180deg,#c7d2fe,#93c5fd); color:#0b1220}

    /* Stage */
    .stage{display:grid; place-items:center; min-height:420px; position:relative; overflow:hidden}
    .circle{
      width: clamp(180px, 70vw, 420px);          /* –∫–ª—é—á–µ–≤–æ–π —Ñ–∏–∫—Å: –∞–¥–µ–∫–≤–∞—Ç–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      aspect-ratio: 1 / 1;
      border-radius:50%;
      background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      display:grid; place-items:center;
      transition: transform 4s ease-in-out;
      transform: scale(1);
      box-shadow: inset 0 2px 10px rgba(255,255,255,.06), 0 18px 40px rgba(0,0,0,.35);
      margin-inline:auto;             /* –∏—Å–∫–ª—é—á–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è */
      max-width: 100%;
    }
    .phase{text-align:center}
    .phase .name{font-size:clamp(16px,2.8vw,20px)}
    .phase .sec{font-variant-numeric:tabular-nums; font-weight:800; font-size:clamp(26px,6vw,44px)}

    .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px}

    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:8px}
    @media (max-width:420px){ .kpi{grid-template-columns:1fr 1fr} }
    .tile{background:rgba(255,255,255,.04); border:1px solid var(--brd); border-radius:12px; padding:10px; text-align:center}
    .label{font-size:12px; color:var(--muted)}
    .value{font-size:18px; font-weight:800}
    .dots{display:flex; gap:8px; justify-content:center; margin-top:6px}
    .dot{width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.15)}
    .dot.on{background:linear-gradient(180deg,var(--accent2),#22c55e)}
    .hint{text-align:center; margin-top:8px; color:#c7d2fe}
    .share{display:flex; gap:8px; justify-content:center; margin-top:10px}
    .hidden{display:none !important}

    /* –î–æ–ø. –º–æ–±–∏–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è: —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –∏ —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ */
    @media (max-width:420px){
      body{padding:10px}
      .app{padding:12px}
      .card{padding:10px}
      select,button{padding:8px 10px; font-size:13px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>–ú–µ–¥–∏—Ç–∞—Ü–∏—è –¥—ã—Ö–∞–Ω–∏–µ–º –æ—Ç AnyClass</h1>
        <div class="sub">–ö—Ä—É–≥–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è, –∑–≤—É–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π</div>
      </div>
      <div class="row">
        <label><span class="muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
          <select id="duration">
            <option value="1">1 –º–∏–Ω</option>
            <option value="3" selected>3 –º–∏–Ω</option>
            <option value="5">5 –º–∏–Ω</option>
            <option value="10">10 –º–∏–Ω</option>
            <option value="15">15 –º–∏–Ω</option>
          </select>
        </label>
        <label><span class="muted">–ú—É–∑—ã–∫–∞</span>
          <input id="musicToggle" type="checkbox" />
        </label>
      </div>
    </header>

    <div class="grid">
      <!-- Stage -->
      <section class="card stage">
        <div class="circle" id="circle">
          <div class="phase">
            <div class="name" id="phaseName">–ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—á–∞–ª—É</div>
            <div class="sec" id="phaseSec">‚Äî</div>
          </div>
        </div>
        <div class="controls">
          <button id="btnStart">–°—Ç–∞—Ä—Ç</button>
          <button id="btnPause" class="ghost" disabled>–ü–∞—É–∑–∞</button>
          <button id="btnReset" class="alt" disabled>–°–±—Ä–æ—Å</button>
        </div>
        <div class="hint" id="hint">–°–ª–µ–¥—É–π –∑–∞ –∫—Ä—É–≥–æ–º: –í–¥–æ—Ö ‚Üí –ü–∞—É–∑–∞ ‚Üí –í—ã–¥–æ—Ö ‚Üí –ü–∞—É–∑–∞ (4‚Äë4‚Äë4‚Äë4)</div>
        <div class="share hidden" id="shareRow">
          <button id="btnShare" class="ghost">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
          <a id="btnShareTG" class="ghost" target="_blank" rel="noopener">–í Telegram</a>
        </div>
      </section>

      <!-- Stats -->
      <aside class="card">
        <div class="kpi">
          <div class="tile">
            <div class="label">–ú–∏–Ω—É—Ç –∑–∞ 7 –¥–Ω–µ–π</div>
            <div class="value" id="statMinutes">0</div>
          </div>
          <div class="tile">
            <div class="label">Streak (–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥)</div>
            <div class="value" id="statStreak">0</div>
          </div>
          <div class="tile">
            <div class="label">–ù–µ–¥–µ–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
            <div class="value"><div class="dots" id="weekDots"></div></div>
          </div>
        </div>
        <p class="muted" style="margin:10px 0 0">–°–æ–≤–µ—Ç: –ø–æ–ø—Ä–æ–±—É–π 3 –º–∏–Ω—É—Ç—ã —É—Ç—Ä–æ–º –∏ 5 –º–∏–Ω—É—Ç –≤–µ—á–µ—Ä–æ–º ‚Äî —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥—ã—Ö–∞–Ω–∏–µ –∏ —Å–æ–Ω.</p>
      </aside>
    </div>
  </div>

  <script>
    // ---------- UI refs ----------
    const $ = (id)=>document.getElementById(id);
    const durationSel = $('duration');
    const circle = $('circle');
    const phaseName = $('phaseName');
    const phaseSec = $('phaseSec');
    const shareRow = $('shareRow');
    const shareBtn = $('btnShare');
    const shareTG = $('btnShareTG');
    const musicToggle = $('musicToggle');

    // ---------- Breathing config (4-4-4-4) ----------
    const phases = [
      {name:'–í–¥–æ—Ö',   sec:4, scale:1.16},
      {name:'–ü–∞—É–∑–∞',  sec:4, scale:1.16},
      {name:'–í—ã–¥–æ—Ö',  sec:4, scale:0.84},
      {name:'–ü–∞—É–∑–∞',  sec:4, scale:0.84},
    ];
    let i=0, t=0, timer=null, paused=false;
    let sessionTimer=null, sessionRemain=0, sessionMin=3;

    // ---------- Stats (7-day window) ----------
    const LS_KEY='anyclass_meditation_stats_v2';
    function loadStats(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || { byDay:{}, streak:0, lastDay:null }; }
      catch(e){ return { byDay:{}, streak:0, lastDay:null }; }
    }
    function saveStats(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
    function todayISO(d=new Date()){ d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
    function yestISO(){ const d=new Date(); d.setDate(d.getDate()-1); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
    function sumLast7(byDay){
      let sum=0; const d=new Date();
      for(let k=0;k<7;k++){ const dd=new Date(d); dd.setDate(d.getDate()-k); const key=todayISO(dd); sum += byDay[key]||0; }
      return sum;
    }
    function weekDotsCount(byDay){
      let cnt=0; const d=new Date();
      for(let k=0;k<7;k++){ const dd=new Date(d); dd.setDate(d.getDate()-k); const key=todayISO(dd); if((byDay[key]||0)>0) cnt++; }
      return cnt;
    }
    function renderDots(container, count){
      container.innerHTML=''; for(let i=0;i<7;i++){ const d=document.createElement('div'); d.className='dot'+(i<count?' on':''); container.appendChild(d); }
    }
    function updateStatsUI(){
      const s=loadStats();
      $('statMinutes').textContent = sumLast7(s.byDay)|0;
      $('statStreak').textContent  = s.streak|0;
      renderDots($('weekDots'), weekDotsCount(s.byDay));
    }

    // ---------- Simple sounds (start/end) ----------
    let audioCtx;
    function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    function tone(freq=660, dur=0.25, type='sine', gain=0.05){
      ensureCtx();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      const t=audioCtx.currentTime; g.gain.exponentialRampToValueAtTime(gain, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur); o.start(t); o.stop(t+dur+0.02);
    }
    function chimeStart(){ tone(660,0.18); setTimeout(()=>tone(880,0.18),140); }
    function gongEnd(){ tone(520,0.32); setTimeout(()=>tone(392,0.38),220); }

    // ---------- Calm pad (procedural background, no files) ----------
    let padGain=null, padNodes=[];
    function startPad(){
      if(!musicToggle.checked) return;
      ensureCtx();
      padGain = audioCtx.createGain(); padGain.gain.value=0.0001; padGain.connect(audioCtx.destination);
      const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=800; lp.Q.value=0.7; lp.connect(padGain);
      const makeVoice=(freq, detune)=>{
        const o = audioCtx.createOscillator(); o.type='sine'; o.frequency.value=freq; o.detune.value=detune;
        const g = audioCtx.createGain(); g.gain.value=0.06; o.connect(g); g.connect(lp); o.start(); return {o,g};
      };
      padNodes = [ makeVoice(220, 0), makeVoice(277.18, -6) ];
      const lfo = audioCtx.createOscillator(); const lfoGain = audioCtx.createGain();
      lfo.type='sine'; lfo.frequency.value=0.08; lfoGain.gain.value=0.02; lfo.connect(lfoGain); lfoGain.connect(padGain.gain); lfo.start();
      padNodes.push({o:lfo,g:lfoGain});
      const t=audioCtx.currentTime; padGain.gain.exponentialRampToValueAtTime(0.08, t+1.2);
    }
    function stopPad(){
      if(!audioCtx || !padGain) return;
      const t=audioCtx.currentTime;
      try{ padGain.gain.exponentialRampToValueAtTime(0.0001, t+0.8);}catch(e){}
      setTimeout(()=>{ padNodes.forEach(n=>{try{n.o.stop();}catch(e){}}); padNodes=[]; try{padGain.disconnect();}catch(e){} padGain=null; }, 900);
    }

    // ---------- Session control ----------
    $('btnStart').addEventListener('click', start);
    $('btnPause').addEventListener('click', togglePause);
    $('btnReset').addEventListener('click', reset);
    durationSel.addEventListener('change', ()=> sessionMin = Number(durationSel.value));
    sessionMin = Number(durationSel.value);

    function start(){
      if(timer) return;
      i=0; paused=false; shareRow.classList.add('hidden');
      sessionRemain = sessionMin*60;
      phaseName.textContent = phases[0].name; phaseSec.textContent = phases[0].sec;
      circle.style.transform = `scale(${phases[0].scale})`;
      $('btnPause').disabled=false; $('btnReset').disabled=false; $('btnStart').disabled=true;
      chimeStart(); startPad();
      runSession(); nextPhase();
    }
    function runSession(){
      sessionTimer = setInterval(()=>{
        if(!paused){
          sessionRemain--;
          if(sessionRemain<=0){ finish(); }
        }
      },1000);
    }
    function nextPhase(){
      const p = phases[i];
      t = p.sec;
      phaseName.textContent = p.name; phaseSec.textContent = t;
      circle.style.transitionDuration = Math.max(1.0, p.sec*0.85)+'s';
      circle.style.transform = `scale(${p.scale})`;
      timer = setInterval(()=>{
        if(!paused){
          t--; phaseSec.textContent = t;
          if(t<=0){
            clearInterval(timer); timer=null;
            i=(i+1)%phases.length;
            if(sessionRemain>0) nextPhase();
          }
        }
      },1000);
    }
    function togglePause(){
      if(!timer && sessionRemain<=0) return;
      paused = !paused;
      $('btnPause').textContent = paused? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–ü–∞—É–∑–∞';
      if(paused) stopPad(); else startPad();
    }
    function reset(){
      if(timer){ clearInterval(timer); timer=null; }
      if(sessionTimer){ clearInterval(sessionTimer); sessionTimer=null; }
      paused=false; sessionRemain=0;
      circle.style.transform='scale(1)'; phaseName.textContent='–ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—á–∞–ª—É'; phaseSec.textContent='‚Äî';
      $('btnPause').disabled=true; $('btnReset').disabled=true; $('btnStart').disabled=false;
      shareRow.classList.add('hidden'); stopPad();
    }
    function finish(){
      clearInterval(sessionTimer); sessionTimer=null;
      if(timer){ clearInterval(timer); timer=null; }
      $('btnStart').disabled=false; $('btnPause').disabled=true;
      gongEnd(); stopPad();
      phaseName.textContent='–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'; phaseSec.textContent='‚úì';
      // stats
      const s=loadStats(); const today=todayISO();
      s.byDay[today] = (s.byDay[today]||0) + sessionMin;
      if(s.lastDay !== today){ if(s.lastDay === yestISO()) s.streak=(s.streak||0)+1; else s.streak=1; s.lastDay=today; }
      saveStats(s); updateStatsUI();
      // share
      shareRow.classList.remove('hidden');
      const msg = `–Ø –∑–∞–≤–µ—Ä—à–∏–ª–∞ ${sessionMin}-–º–∏–Ω—É—Ç–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –¥—ã—Ö–∞–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è üôè`;
      shareBtn.onclick = async ()=> {
        if(navigator.share){ try{ await navigator.share({title:'–ú–µ–¥–∏—Ç–∞—Ü–∏—è –¥—ã—Ö–∞–Ω–∏–µ–º –æ—Ç AnyClass', text:msg, url:window.location.href}); }catch(e){} }
        else { alert('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É Telegram.'); }
      };
      shareTG.href = "https://t.me/share/url?url=" + encodeURIComponent(window.location.href) + "&text=" + encodeURIComponent(msg);
    }

    // ---------- init ----------
    (function init(){
      updateStatsUI();
      const dots=$('weekDots'); dots.innerHTML=''; for(let k=0;k<7;k++){ const d=document.createElement('div'); d.className='dot'; dots.appendChild(d); }
      renderDots(dots, weekDotsCount(loadStats().byDay||{}));
    })();
  </script>
</body>
</html>
